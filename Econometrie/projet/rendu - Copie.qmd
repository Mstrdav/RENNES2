---
title: "La source du bonheur" 
format:
  html:
    other-links:
      - text: Colin
        href: https://colin.geind.re/
      - text: Denis
        href: https://dataforgood.fr/
    css: style.css
    toc: true
    toc_depth: 3
    toc_float: true
    collapsed: true
    smooth_scroll: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE) # Activer le cache des chunks pour accélérer les recompilations
options("install.lock" = FALSE) # Désactiver le verrouillage d’installation des packages
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(pastecs)
library(stargazer)
library(psych)
library(ggplot2)
library(car)
library(lmtest)
library(sandwich)
library(corrplot)
library(olsrr) # graohique des résidus
library(gridExtra)

```

```{r}

# Enlever les commentaires
# étoffer le plan
# numéroter les graphiques et tableaux
# labeliser les axes
# pas de code R dans le rendu final html juste les graphiques et les commentaires
# stat desc : décrire les résultats : interpréter ou analyser
# selectionner les graphiques pertinents et ne pas tout montrer
# un document de référence
# Ne pas utiliser le code de la variable dans l interprétation

# spécifier nos sélections de variables si ce n'est déjà fait

```

**JAOUEN Denis - GEINDRE Colin**

```{r echo=FALSE}
# import des données
data <- read.csv(file = "donnees.csv", row.names = 2)[, -1] # pour enlever la colonne "numero"
# transform OCDE variable into factor
data$OCDE <- as.factor(data$OCDE)
```

```{r echo=FALSE}
# Etude des statistiques descriptives
data_numeric <- data[, sapply(data, is.numeric)]
stargazer(data_numeric,
    type = "text", title = "Statistiques descriptives", digits = 2,
    summary.stat = c("mean", "sd", "min", "median", "max")
)

```

::: {#fig1 .fig}
```{r echo=FALSE}
# histogramme de la variable cible
ggplot(data, aes(x = Happiness)) +
    geom_histogram(binwidth = 0.25, fill = "salmon1", color = "black", alpha = 0.7) +
    labs(title = "Histogramme du score de bonheur", x = "Score de bonheur", y = "Fréquence") +
    theme_minimal()
```

Figure 1 : Histogramme du score de bonheur
:::

::: {#fig2 .fig}
```{r echo=FALSE}
# boxplot de la variable cible
ggplot(data, aes(y = Happiness)) +
    geom_boxplot(fill = "salmon1", color = "black", alpha = 0.7) +
    labs(title = "Boxplot du score de bonheur", y = "Score de bonheur") +
    theme_minimal()
```

Figure 2 : Boxplot du score de bonheur
:::

```{r echo=FALSE, fig.height=12, fig.width=12}
plots <- list()

nomsdevar = c("Corruption politique", "PIB par habitant", "Espérance de vie", "Migration nette", "Surpoids", "Densité de population", "Consommation énergétique", "Dépenses militaires", "Croissance de population", "Inscriptions à l'école primaire")


for (i in 1:ncol(data_numeric)) {
    p <- ggplot(data_numeric, aes_string(x = data_numeric[[i]])) +
        geom_histogram(binwidth = diff(range(data_numeric[[i]])) / 30, fill = "salmon1", color = "black", alpha = 0.7) +
        labs(x = nomsdevar[i], y = "") +
        theme_minimal() +
        theme(plot.margin = grid::unit(c(0.5, 0.5, 0.5, 0.5), "cm"))
    plots[[i]] <- p
}
plots <- plots[-11]

```

::: {#fig3 .fig}
```{r echo=FALSE}
do.call(grid.arrange, c(plots[c(4, 8, 9, 10)], ncol = 2))
```

Figure 3 : Histogrammes sélectionnés (Population growth, Primary school enrollment, Military expenses, Net migration)
:::

::: {#fig4 .fig}
```{r echo=FALSE}
do.call(grid.arrange, c(plots[c(2, 6, 7)], ncol = 2))
```

Figure 4 : Histogrammes sélectionnés (GDP per capita, Population density, KWH per capita)
:::

::: {#fig5 .fig}
```{r echo=FALSE}
do.call(grid.arrange, c(plots[c(1, 3, 5)], ncol = 2))
```

Figure 5 : Histogrammes sélectionnés (Political corruption, Lifespan at birth, Overweight adults)
:::

```{r echo=FALSE}
# Corrélations simples et affichage graphique (base R)
vars <- names(data_numeric)[-ncol(data_numeric)]
cors <- sapply(vars, function(v) cor(data_numeric$Happiness, data_numeric[[v]]))
# trier par valeur (pour barplot horizontal)
names(cors) = nomsdevar
cors_sorted <- sort(cors)
```

::: {#fig6 .fig}
```{r echo=FALSE, fig.height=5, fig.width=8}


par(mar=c(4,12,4.1,1))

barplot(cors_sorted,
    horiz = TRUE, las = 1,
    # bicolor
    col = ifelse(cors_sorted > 0, "lightblue", "salmon1"),
    main = "Corrélations des variables avec l'indice de bonheur",
)

scatter_plots <- list()

for (i in 2:11) {
    p <- ggplot(data, aes_string(x = data[[i]], y = "Happiness")) +
        geom_point() +
        geom_smooth(method = lm, color = "salmon1", fill = "lightblue", se = TRUE) +
        labs(x = nomsdevar[i-1], y = "Happiness") +
        theme_minimal()
    scatter_plots[[i - 1]] <- p
}

```

Figure 6 : Corrélations des variables explicatives avec l'indice de bonheur
:::


::: {#fig7 .fig}
```{r echo=FALSE, fig.height=6, fig.width=8}
# Tracé des graphes de points et de la linéarité


do.call(grid.arrange, c(scatter_plots[c(3)], ncol = 1))
```

Figure 7 : Nuage de points entre l'espérance de vie et l'indice de bonheur
:::

::: {#fig8 .fig}
```{r echo=FALSE, fig.height=6, fig.width=8}

do.call(grid.arrange, c(scatter_plots[c(1,5,9,8)], ncol = 2))
```

Figure 8 : Nuages de points assez dispersés
:::

```{r echo=FALSE}

data_ss_singapour <- data[-which(data$Code == "SGP"), ]
sspopplot <- ggplot(data_ss_singapour, aes_string(x = "Population_Density", y = "Happiness")) +
    geom_point(color = "blue") +
    geom_smooth(method = lm, color = "salmon1", fill = "lightblue", se = TRUE) +
    labs(x = "Sans Singapour", y = "Happiness") +
    theme_minimal()


data_ss_somalie <- data[-which(data$Code == "SOM"), ]
ssschoolplot <- ggplot(data_ss_somalie, aes_string(x = "Primary_School_Enrollment", y = "Happiness")) +
    geom_point(color = "blue") +
    geom_smooth(method = lm, color = "salmon1", fill = "lightblue", se = TRUE) +
    labs(x = "Sans la Somalie", y = "Happiness") +
    theme_minimal()

data_ss_pak_usa <- data[-which(data$Code == "PAK" | data$Code == "USA"), ]
ssmigrationplot <- ggplot(data_ss_pak_usa, aes_string(x = "Net_Migration", y = "Happiness")) +
    geom_point(color = "blue") +
    geom_smooth(method = lm, color = "salmon1", fill = "lightblue", se = TRUE) +
    labs(x = "Sans les EU ni le Pakistan", y = "Happiness") +
    theme_minimal()

outlierplots <- list(ssmigrationplot, sspopplot, ssschoolplot)

```

::: {#fig9 .fig}
```{r echo=FALSE, fig.height=6, fig.width=8}

do.call(grid.arrange, c(c(scatter_plots[c(4,6,10)],outlierplots), ncol = 3))
```

Figure 9 : Nuage de points les plus concentrés
:::

```{r echo=FALSE}
data_PIB_log <- data
data_PIB_log$GDP_per_Capita <- log(data_PIB_log$GDP_per_Capita)
PIBplot <- ggplot(data_PIB_log, aes_string(x = "GDP_per_Capita", y = "Happiness")) +
    geom_point(color = "blue") +
    geom_smooth(method = lm, color = "salmon1", fill = "lightblue", se = TRUE) +
    labs(x = "Logarithme du PIB par habitant", y = "Happiness") +
    theme_minimal()


data_KWH_log <- data
data_KWH_log$KWH_pp_pc <- log(data_KWH_log$KWH_pp_pc)
KWHplot <- ggplot(data_KWH_log, aes_string(x = "KWH_pp_pc", y = "Happiness")) +
    geom_point(color = "blue") +
    geom_smooth(method = lm, color = "salmon1", fill = "lightblue", se = TRUE) +
    labs(x = "Logarithme de la consommmation énergétique", y = "Happiness") +
    theme_minimal()


data_migration <- data
data_migration$Net_Migration <- log(data_migration$Net_Migration)
migrationplot <- ggplot(data_migration, aes_string(x = "Net_Migration", y = "Happiness")) +
    geom_point() +
    geom_smooth(method = lm, color = "salmon1", fill = "lightblue", se = TRUE) +
    labs(x = "Logarithme de la migration", y = "Happiness") +
    theme_minimal()

logplots <- list(PIBplot, KWHplot, migrationplot)
```

::: {#fig10 .fig}
```{r echo=FALSE, fig.height=6, fig.width=8}

do.call(grid.arrange, c(scatter_plots[c(2,7)],logplots[c(1,2)], ncol = 2))
```

Figure 10 : Nuages de points avec l'indice de bonheur des variables bénéficiant d'une transformation logarithmique et lesdites transformations
:::
